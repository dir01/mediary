# Mediary


## What is Mediary
Mediary is a service that can download, convert and upload media

Example use cases:

- Given a magnet link, download files A, B and C, glue them together and upload to this pre-signed S3 URL
- (to be done) Given a youtube link, take 720p URL, extract audio and upload it to this pre-signed S3 URL
- (to be done) Given a link to a single file, just take it and upload it to this pre-signed S3 URL


## API
- `GET /metadata` - returns metadata for a given media link. You are going to need it if you want 
to pick and choose which files should be processed.
- `POST /job` - creates a task to upload media. Describes the source URL, files at source URL
    to be processed, what transformation to apply and where to upload the result.
- `GET /job/{id}` - returns the status of a job.


## Examples
<!-- start autogenerated samples -->
### `/metadata` - Timeouts

By default, the endpoint will timeout pretty quickly, 
probably sooner than it takes to fetch metadata of a torrent, for example.

In such cases, the endpoint will return a `202 Accepted` status code and a message `{"status": "accepted"}`

Feel free to repeat your request later: metadata is still being fetched in background.


```
$ curl -X GET '/metadata?url=magnet:?xt=urn:btih:FB0B49D5E3E18E29868C680D2F7BC00D67987D56&tr=http%3A%2F%2Fbt.t-ru.org'
{"status": "accepted"}
```


### `/metadata/long-polling`

In case you'd rather wait for the metadata to be fetched, you can use the long-polling endpoint.

It will not return a response until the metadata is fetched.

There is still a timeout on the request, but it's pretty long (5 minutes).

```
$ curl -X GET '/metadata/long-polling?url=magnet:?xt=urn:btih:FB0B49D5E3E18E29868C680D2F7BC00D67987D56&tr=http%3A%2F%2Fbt.t-ru.org'
{
  "url": "magnet:?xt=urn:btih:FB0B49D5E3E18E29868C680D2F7BC00D67987D56",
  "name": "Джо Диспенза - Медитации к Силе подсознания [Александр Шаронов]",
  "files": [
    {
      "path": "глава 2.mp3",
      "length_bytes": 42107250
    },
    {
      "path": "глава 1.mp3",
      "length_bytes": 40623850
    },
    {
      "path": "вступление.mp3",
      "length_bytes": 1181881
    }
  ]
}
```


### `/metadata` - Cached

It goes without saying, that once the metadata is fetched, it is cached.

So all consecutive requests for the same URL will return the same metadata, and immediately.

```
$ curl -X GET '/metadata?url=magnet:?xt=urn:btih:FB0B49D5E3E18E29868C680D2F7BC00D67987D56&tr=http%3A%2F%2Fbt.t-ru.org'
{
  "url": "magnet:?xt=urn:btih:FB0B49D5E3E18E29868C680D2F7BC00D67987D56",
  "name": "Джо Диспенза - Медитации к Силе подсознания [Александр Шаронов]",
  "files": [
    {
      "path": "глава 2.mp3",
      "length_bytes": 42107250
    },
    {
      "path": "глава 1.mp3",
      "length_bytes": 40623850
    },
    {
      "path": "вступление.mp3",
      "length_bytes": 1181881
    }
  ]
}
```


### `/jobs` 

POST to `/jobs` will schedule for background execution a process of downloading, converting/processing and uploading the media.
Only required parameters are `url` and `type`. `type` signifies the type of operation to be performed. 
Each operation can require some additional parameters, passed as `params`. For example, `concatenate` job
requires a list of files to be concatenated and, optionally, an `audioCoded` to be used for the output file.

```
$ curl -X POST '/jobs'
{"status": "accepted", "id": "a9502f6fa9dc632906fa1ac92381cfec"}
```


### `/jobs/:id`

Since jobs can run for a long time, job creation api responds immediately with a job ID.
To check the status of the job, you can use the `/jobs/:id` endpoint.

0s after starting the job:

```
$ curl -X GET '/jobs/a9502f6fa9dc632906fa1ac92381cfec'
{
  "url": "magnet:?xt=urn:btih:58C665647C1A34019A0DC99C9046BD459F006B73\u0026tr=http%3A%2F%2Fbt3.t-ru.org",
  "type": "concatenate",
  "params": {
    "audioCodec": "mp3",
    "filepaths": [
      "01-001.mp3",
      "01-002.mp3"
    ],
    "uploadUrl": "http://localhost:50287/some-bucket/some-path/some-file.some-ext?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=dummy%2F20220928%2F%2Fs3%2Faws4_request\u0026X-Amz-Date=20220928T072916Z\u0026X-Amz-Expires=900\u0026X-Amz-Security-Token=dummy\u0026X-Amz-SignedHeaders=host\u0026x-id=PutObject\u0026X-Amz-Signature=6a1f4b264b2a565a642a99f09e9e4b073e0ab49638d461339ea61399acc7f8c0"
  },
  "id": "a9502f6fa9dc632906fa1ac92381cfec",
  "status": "downloading"
}
```


4s later:

```
$ curl -X GET '/jobs/a9502f6fa9dc632906fa1ac92381cfec'
{
  "url": "magnet:?xt=urn:btih:58C665647C1A34019A0DC99C9046BD459F006B73\u0026tr=http%3A%2F%2Fbt3.t-ru.org",
  "type": "concatenate",
  "params": {
    "audioCodec": "mp3",
    "filepaths": [
      "01-001.mp3",
      "01-002.mp3"
    ],
    "uploadUrl": "http://localhost:50287/some-bucket/some-path/some-file.some-ext?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=dummy%2F20220928%2F%2Fs3%2Faws4_request\u0026X-Amz-Date=20220928T072916Z\u0026X-Amz-Expires=900\u0026X-Amz-Security-Token=dummy\u0026X-Amz-SignedHeaders=host\u0026x-id=PutObject\u0026X-Amz-Signature=6a1f4b264b2a565a642a99f09e9e4b073e0ab49638d461339ea61399acc7f8c0"
  },
  "id": "a9502f6fa9dc632906fa1ac92381cfec",
  "status": "processing"
}
```


54s later:

```
$ curl -X GET '/jobs/a9502f6fa9dc632906fa1ac92381cfec'
{
  "url": "magnet:?xt=urn:btih:58C665647C1A34019A0DC99C9046BD459F006B73\u0026tr=http%3A%2F%2Fbt3.t-ru.org",
  "type": "concatenate",
  "params": {
    "audioCodec": "mp3",
    "filepaths": [
      "01-001.mp3",
      "01-002.mp3"
    ],
    "uploadUrl": "http://localhost:50287/some-bucket/some-path/some-file.some-ext?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=dummy%2F20220928%2F%2Fs3%2Faws4_request\u0026X-Amz-Date=20220928T072916Z\u0026X-Amz-Expires=900\u0026X-Amz-Security-Token=dummy\u0026X-Amz-SignedHeaders=host\u0026x-id=PutObject\u0026X-Amz-Signature=6a1f4b264b2a565a642a99f09e9e4b073e0ab49638d461339ea61399acc7f8c0"
  },
  "id": "a9502f6fa9dc632906fa1ac92381cfec",
  "status": "uploading"
}
```


2s later:

```
$ curl -X GET '/jobs/a9502f6fa9dc632906fa1ac92381cfec'
{
  "url": "magnet:?xt=urn:btih:58C665647C1A34019A0DC99C9046BD459F006B73\u0026tr=http%3A%2F%2Fbt3.t-ru.org",
  "type": "concatenate",
  "params": {
    "audioCodec": "mp3",
    "filepaths": [
      "01-001.mp3",
      "01-002.mp3"
    ],
    "uploadUrl": "http://localhost:50287/some-bucket/some-path/some-file.some-ext?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=dummy%2F20220928%2F%2Fs3%2Faws4_request\u0026X-Amz-Date=20220928T072916Z\u0026X-Amz-Expires=900\u0026X-Amz-Security-Token=dummy\u0026X-Amz-SignedHeaders=host\u0026x-id=PutObject\u0026X-Amz-Signature=6a1f4b264b2a565a642a99f09e9e4b073e0ab49638d461339ea61399acc7f8c0"
  },
  "id": "a9502f6fa9dc632906fa1ac92381cfec",
  "status": "complete"
}
```

<!-- stop autogenerated samples -->

