# Mediary


## What is Mediary
Mediary is a service that can download, convert and upload media

Example use cases:

- Given a magnet link, download files A, B and C, glue them together and upload to this pre-signed S3 URL
- (to be done) Given a youtube link, take 720p URL, extract audio and upload it to this pre-signed S3 URL
- (to be done) Given a link to a single file, just take it and upload it to this pre-signed S3 URL


## API
- `GET /metadata` - returns metadata for a given media link. You are going to need it if you want 
to pick and choose which files should be processed.
- `POST /job` - creates a task to upload media. Describes the source URL, files at source URL
    to be processed, what transformation to apply and where to upload the result.
- `GET /job/{id}` - returns the status of a job.


## Examples
<!-- start autogenerated samples -->
### `/metadata` - Timeouts

By default, the endpoint will timeout pretty quickly, 
probably sooner than it takes to fetch metadata of a torrent, for example.

In such cases, the endpoint will return a `202 Accepted` status code and a message `{"status": "accepted"}`

Feel free to repeat your request later: metadata is still being fetched in background.


```
$ curl -X GET '/metadata?url=magnet:?xt=urn:btih:1EAA77FA58C40D5499914AE740EC7F906EF10D65'
{"status": "accepted"}
```


### `/metadata/long-polling`

In case you'd rather wait for the metadata to be fetched, you can use the long-polling endpoint.

It will not return a response until the metadata is fetched.

There is still a timeout on the request, but it's pretty long (5 minutes).

```
$ curl -X GET '/metadata/long-polling?url=magnet:?xt=urn:btih:1EAA77FA58C40D5499914AE740EC7F906EF10D65'
{
  "url": "magnet:?xt=urn:btih:1EAA77FA58C40D5499914AE740EC7F906EF10D65",
  "name": "John Coltrane - A Love Supreme (1965) (Acoustic Sounds Series) (PBTHAL LP 24-96) [FLAC] vtwin88cube",
  "files": [
    {
      "path": "00.-John Coltrane - A Love Supreme.m3u",
      "length_bytes": 111
    },
    {
      "path": "01.-Part 1 - Acknowledgement.flac",
      "length_bytes": 170093783
    },
    {
      "path": "02.-Part 2 - Resolution.flac",
      "length_bytes": 165357192
    },
    {
      "path": "03.-Part 3 - Pursuance \u0026 Part 4 - Psalm.flac",
      "length_bytes": 386514548
    },
    {
      "path": "DR13.txt",
      "length_bytes": 979
    },
    {
      "path": "folder.jpg",
      "length_bytes": 187670
    },
    {
      "path": "lineage.txt",
      "length_bytes": 556
    }
  ]
}
```


### `/metadata` - Cached

It goes without saying, that once the metadata is fetched, it is cached.

So all consecutive requests for the same URL will return the same metadata, and immediately.

```
$ curl -X GET '/metadata?url=magnet:?xt=urn:btih:1EAA77FA58C40D5499914AE740EC7F906EF10D65'
{
  "url": "magnet:?xt=urn:btih:1EAA77FA58C40D5499914AE740EC7F906EF10D65",
  "name": "John Coltrane - A Love Supreme (1965) (Acoustic Sounds Series) (PBTHAL LP 24-96) [FLAC] vtwin88cube",
  "files": [
    {
      "path": "00.-John Coltrane - A Love Supreme.m3u",
      "length_bytes": 111
    },
    {
      "path": "01.-Part 1 - Acknowledgement.flac",
      "length_bytes": 170093783
    },
    {
      "path": "02.-Part 2 - Resolution.flac",
      "length_bytes": 165357192
    },
    {
      "path": "03.-Part 3 - Pursuance \u0026 Part 4 - Psalm.flac",
      "length_bytes": 386514548
    },
    {
      "path": "DR13.txt",
      "length_bytes": 979
    },
    {
      "path": "folder.jpg",
      "length_bytes": 187670
    },
    {
      "path": "lineage.txt",
      "length_bytes": 556
    }
  ]
}
```


### `/jobs` 

POST to `/jobs` will schedule for background execution a process of downloading, converting/processing and uploading the media.
Only required parameters are `url` and `type`. `type` signifies the type of operation to be performed. 
Each operation can require some additional parameters, passed as `params`. For example, `concatenate` job
requires a list of files to be concatenated and, optionally, an `audioCoded` to be used for the output file.

```
$ curl -X POST '/jobs'
{"status": "accepted", "id": "63ef9b913789f9f15bdbdaec832e4629"}
```


### `/jobs/:id`

Since jobs can run for a long time, job creation api responds immediately with a job ID.
To check the status of the job, you can use the `/jobs/:id` endpoint.

0s after starting the job:

```
$ curl -X GET '/jobs/63ef9b913789f9f15bdbdaec832e4629'
{
  "url": "magnet:?xt=urn:btih:58C665647C1A34019A0DC99C9046BD459F006B73\u0026tr=http%3A%2F%2Fbt3.t-ru.org",
  "type": "concatenate",
  "params": {
    "audioCodec": "mp3",
    "filepaths": [
      "01-001.mp3",
      "01-002.mp3"
    ],
    "uploadUrl": "http://localhost:49826/some-bucket/some-path/some-file.some-ext?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=dummy%2F20220917%2F%2Fs3%2Faws4_request\u0026X-Amz-Date=20220917T140534Z\u0026X-Amz-Expires=900\u0026X-Amz-Security-Token=dummy\u0026X-Amz-SignedHeaders=host\u0026x-id=PutObject\u0026X-Amz-Signature=56e1475e61f50e88a36689839b2afd58bc124d7b6974807d07a701184495fb59"
  },
  "id": "63ef9b913789f9f15bdbdaec832e4629",
  "status": "downloading"
}
```


5s later:

```
$ curl -X GET '/jobs/63ef9b913789f9f15bdbdaec832e4629'
{
  "url": "magnet:?xt=urn:btih:58C665647C1A34019A0DC99C9046BD459F006B73\u0026tr=http%3A%2F%2Fbt3.t-ru.org",
  "type": "concatenate",
  "params": {
    "audioCodec": "mp3",
    "filepaths": [
      "01-001.mp3",
      "01-002.mp3"
    ],
    "uploadUrl": "http://localhost:49826/some-bucket/some-path/some-file.some-ext?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=dummy%2F20220917%2F%2Fs3%2Faws4_request\u0026X-Amz-Date=20220917T140534Z\u0026X-Amz-Expires=900\u0026X-Amz-Security-Token=dummy\u0026X-Amz-SignedHeaders=host\u0026x-id=PutObject\u0026X-Amz-Signature=56e1475e61f50e88a36689839b2afd58bc124d7b6974807d07a701184495fb59"
  },
  "id": "63ef9b913789f9f15bdbdaec832e4629",
  "status": "processing"
}
```


47s later:

```
$ curl -X GET '/jobs/63ef9b913789f9f15bdbdaec832e4629'
{
  "url": "magnet:?xt=urn:btih:58C665647C1A34019A0DC99C9046BD459F006B73\u0026tr=http%3A%2F%2Fbt3.t-ru.org",
  "type": "concatenate",
  "params": {
    "audioCodec": "mp3",
    "filepaths": [
      "01-001.mp3",
      "01-002.mp3"
    ],
    "uploadUrl": "http://localhost:49826/some-bucket/some-path/some-file.some-ext?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=dummy%2F20220917%2F%2Fs3%2Faws4_request\u0026X-Amz-Date=20220917T140534Z\u0026X-Amz-Expires=900\u0026X-Amz-Security-Token=dummy\u0026X-Amz-SignedHeaders=host\u0026x-id=PutObject\u0026X-Amz-Signature=56e1475e61f50e88a36689839b2afd58bc124d7b6974807d07a701184495fb59"
  },
  "id": "63ef9b913789f9f15bdbdaec832e4629",
  "status": "uploading"
}
```


2s later:

```
$ curl -X GET '/jobs/63ef9b913789f9f15bdbdaec832e4629'
{
  "url": "magnet:?xt=urn:btih:58C665647C1A34019A0DC99C9046BD459F006B73\u0026tr=http%3A%2F%2Fbt3.t-ru.org",
  "type": "concatenate",
  "params": {
    "audioCodec": "mp3",
    "filepaths": [
      "01-001.mp3",
      "01-002.mp3"
    ],
    "uploadUrl": "http://localhost:49826/some-bucket/some-path/some-file.some-ext?X-Amz-Algorithm=AWS4-HMAC-SHA256\u0026X-Amz-Credential=dummy%2F20220917%2F%2Fs3%2Faws4_request\u0026X-Amz-Date=20220917T140534Z\u0026X-Amz-Expires=900\u0026X-Amz-Security-Token=dummy\u0026X-Amz-SignedHeaders=host\u0026x-id=PutObject\u0026X-Amz-Signature=56e1475e61f50e88a36689839b2afd58bc124d7b6974807d07a701184495fb59"
  },
  "id": "63ef9b913789f9f15bdbdaec832e4629",
  "status": "complete"
}
```

<!-- stop autogenerated samples -->

